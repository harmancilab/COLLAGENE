# Collective Decryption (collective_decryption_examples.sh)
A collective decryption operation is necessary for decrypting any data that is encrypted with the common public key. In this example, we show exhausting a 
random matrix by multiplying it all the way down to the lowest level and then collectively decrypting it.

You need to make sure *COLLAGENE.sh* script and the DSK directory (named *SITE_DSK_ENC_KEYS/*) are copied from previous example to this folder.

## Matrix Encryption
The encryption uses the public key and is performed using *-encrypt_plaintext_matrix* option.

Following generates a random 10x10 matrix and encrypts it using the public key stored in the parameters of the site 0 (first site).
```
./COLLAGENE.sh -generate_random_plaintext_matrix 10 10 random_matrix_0.bin
./COLLAGENE.sh -encrypt_plaintext_matrix SITE_0 random_matrix_0.bin random_matrix_0.bin.enc
```

---

## Collective Decryption

There are two steps in the collective decryption of a ciphertext:

1) *Partial decryption of the ciphertext by each site:* Each site performs a partial decryption of the encrypted ciphertext using their secret key share:
```
COLLAGENE.sh -partial_decrypt_matrix SITE_0 random_matrix_0.bin.enc 0 ${smdging_noise_var_bit_size} random_matrix_0.bin.enc_partdec_by_0.partdec
COLLAGENE.sh -partial_decrypt_matrix SITE_1 random_matrix_0.bin.enc 1 ${smdging_noise_var_bit_size} random_matrix_0.bin.enc_partdec_by_1.partdec
COLLAGENE.sh -partial_decrypt_matrix SITE_2 random_matrix_0.bin.enc 2 ${smdging_noise_var_bit_size} random_matrix_0.bin.enc_partdec_by_2.partdec
```
This option partially decrypts the encrypted file and stores it in a partially decrypted file. It also adds smudging noise with the variance specified by the command line parameter.

The partial decryptions can be pooled by any external entity. It is therefore important to encrypt the partially decrypted matrices using symmetric encryption keys that are generated by *KeyMaker* and included in the received key directories:
```
COLLAGENE.sh -symmetric_encrypt_partdec_data SITE_0 random_matrix_0.bin_partdec_by_0.partdec RECEIVED_KEYS/site_0_partdec_data_enc_hash.symmetric_key.enc random_matrix_0.bin_partdec_by_0.partdec.enc
COLLAGENE.sh -symmetric_encrypt_partdec_data SITE_1 random_matrix_0.bin_partdec_by_1.partdec RECEIVED_KEYS/site_1_partdec_data_enc_hash.symmetric_key.enc random_matrix_0.bin_partdec_by_1.partdec.enc
COLLAGENE.sh -symmetric_encrypt_partdec_data SITE_2 random_matrix_0.bin_partdec_by_2.partdec RECEIVED_KEYS/site_2_partdec_data_enc_hash.symmetric_key.enc random_matrix_0.bin_partdec_by_2.partdec.enc
```

2) *Pooling of Partially Decryptions*: All partially decrypted data are downloaded by the sites and are first decrypted using the symmetric key.

First site (site-0) would use following to decrypt the partial decryptions:
```
COLLAGENE.sh -symmetric_decrypt_partdec_data SITE_0 random_matrix_0.bin_partdec_by_0.partdec.enc RECEIVED_KEYS/site_0_partdec_data_enc_hash.symmetric_key random_matrix_0.bin_partdec_by_0.partdec
COLLAGENE.sh -symmetric_decrypt_partdec_data SITE_0 random_matrix_0.bin_partdec_by_1.partdec.enc RECEIVED_KEYS/site_1_partdec_data_enc_hash.symmetric_key random_matrix_0.bin_partdec_by_1.partdec
COLLAGENE.sh -symmetric_decrypt_partdec_data SITE_0 random_matrix_0.bin_partdec_by_2.partdec.enc RECEIVED_KEYS/site_2_partdec_data_enc_hash.symmetric_key random_matrix_0.bin_partdec_by_2.partdec
```
Next, the partial decryptions from other sites are merged at the 1st site:
```
ls *.partdec * > PARTDECS.list
COLLAGENE.sh -pool_partially_decrypted_matrices SITE_0 PARTDECS.list random_matrix_0.bin.enc_collaborative_dec.bin
```

## collaborative_decrypt_matrix.sh Script:
To simulate collective decryption protocol more cleanly, we included a script (*collaborative_decrypt_matrix.sh*) to later examples that wraps these steps into one command. 

---

*collective_decryption_examples.sh* contains the implementation of the steps of collective decryption including generation of random matrices and saving matrices in text format.
